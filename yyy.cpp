#define _CRT_SECURE_NO_WARNINGS
#include <math.h>
#include <stdio.h>
#include <sys/types.h>
#include <iostream>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <iomanip>
#include <mpi.h>

#pragma pack(1)

typedef struct BITMAPFILEHEADER
{
    uint16_t bfType;
    uint32_t bfSize;
    uint16_t bfReserved1;
    uint16_t bfReserved2;
    uint32_t bfOffBits;
} BITMAPFILEHEADER;

typedef struct BITMAPINFOHEADER
{
    uint32_t biSize;
    uint32_t biWidth;
    uint32_t biHeight;
    uint16_t biPlanes;
    uint16_t biBitCount;
    uint32_t biCompression;
    uint32_t biSizeImage;
    uint32_t biXPelsPerMeter;
    uint32_t biYPelsPerMeter;
    uint32_t biClrUsed;
    uint32_t biClrImportant;
} BITMAPINFODEADER;

using namespace std;

#define BMP_FILE_NAME "timg.bmp"

const int N = 5;
unsigned char *pBmpBuf = NULL; //读入图像数据的指针
unsigned char *rBmpBuf = NULL;
unsigned char *gBmpBuf = NULL;
unsigned char *bBmpBuf = NULL;

/*******************************************************************************/
//骚操作
double book[6][256] = {{0, 0.014418818362461, 0.028837636724922, 0.043256455087382, 0.057675273449843, 0.072094091812304, 0.086512910174765, 0.10093172853723, 0.11535054689969, 0.12976936526215, 0.14418818362461, 0.15860700198707, 0.17302582034953, 0.18744463871199, 0.20186345707445, 0.21628227543691, 0.23070109379937, 0.24511991216183, 0.25953873052429, 0.27395754888676, 0.28837636724922, 0.30279518561168, 0.31721400397414, 0.3316328223366, 0.34605164069906, 0.36047045906152, 0.37488927742398, 0.38930809578644, 0.4037269141489, 0.41814573251136, 0.43256455087382, 0.44698336923629, 0.46140218759875, 0.47582100596121, 0.49023982432367, 0.50465864268613, 0.51907746104859, 0.53349627941105, 0.54791509777351, 0.56233391613597, 0.57675273449843, 0.59117155286089, 0.60559037122335, 0.62000918958582, 0.63442800794828, 0.64884682631074, 0.6632656446732, 0.67768446303566, 0.69210328139812, 0.70652209976058, 0.72094091812304, 0.7353597364855, 0.74977855484796, 0.76419737321042, 0.77861619157288, 0.79303500993535, 0.80745382829781, 0.82187264666027, 0.83629146502273, 0.85071028338519, 0.86512910174765, 0.87954792011011, 0.89396673847257, 0.90838555683503, 0.92280437519749, 0.93722319355995, 0.95164201192241, 0.96606083028488, 0.98047964864734, 0.9948984670098, 1.0093172853723, 1.0237361037347, 1.0381549220972, 1.0525737404596, 1.0669925588221, 1.0814113771846, 1.095830195547, 1.1102490139095, 1.1246678322719, 1.1390866506344, 1.1535054689969, 1.1679242873593, 1.1823431057218, 1.1967619240842, 1.2111807424467, 1.2255995608092, 1.2400183791716, 1.2544371975341, 1.2688560158966, 1.283274834259, 1.2976936526215, 1.3121124709839, 1.3265312893464, 1.3409501077089, 1.3553689260713, 1.3697877444338, 1.3842065627962, 1.3986253811587, 1.4130441995212, 1.4274630178836, 1.4418818362461, 1.4563006546085, 1.470719472971, 1.4851382913335, 1.4995571096959, 1.5139759280584, 1.5283947464208, 1.5428135647833, 1.5572323831458, 1.5716512015082, 1.5860700198707, 1.6004888382332, 1.6149076565956, 1.6293264749581, 1.6437452933205, 1.658164111683, 1.6725829300455, 1.6870017484079, 1.7014205667704, 1.7158393851328, 1.7302582034953, 1.7446770218578, 1.7590958402202, 1.7735146585827, 1.7879334769451, 1.8023522953076, 1.8167711136701, 1.8311899320325, 1.845608750395, 1.8600275687574, 1.8744463871199, 1.8888652054824, 1.9032840238448, 1.9177028422073, 1.9321216605698, 1.9465404789322, 1.9609592972947, 1.9753781156571, 1.9897969340196, 2.0042157523821, 2.0186345707445, 2.033053389107, 2.0474722074694, 2.0618910258319, 2.0763098441944, 2.0907286625568, 2.1051474809193, 2.1195662992817, 2.1339851176442, 2.1484039360067, 2.1628227543691, 2.1772415727316, 2.191660391094, 2.2060792094565, 2.220498027819, 2.2349168461814, 2.2493356645439, 2.2637544829063, 2.2781733012688, 2.2925921196313, 2.3070109379937, 2.3214297563562, 2.3358485747187, 2.3502673930811, 2.3646862114436, 2.379105029806, 2.3935238481685, 2.407942666531, 2.4223614848934, 2.4367803032559, 2.4511991216183, 2.4656179399808, 2.4800367583433, 2.4944555767057, 2.5088743950682, 2.5232932134306, 2.5377120317931, 2.5521308501556, 2.566549668518, 2.5809684868805, 2.5953873052429, 2.6098061236054, 2.6242249419679, 2.6386437603303, 2.6530625786928, 2.6674813970553, 2.6819002154177, 2.6963190337802, 2.7107378521426, 2.7251566705051, 2.7395754888676, 2.75399430723, 2.7684131255925, 2.7828319439549, 2.7972507623174, 2.8116695806799, 2.8260883990423, 2.8405072174048, 2.8549260357672, 2.8693448541297, 2.8837636724922, 2.8981824908546, 2.9126013092171, 2.9270201275795, 2.941438945942, 2.9558577643045, 2.9702765826669, 2.9846954010294, 2.9991142193919, 3.0135330377543, 3.0279518561168, 3.0423706744792, 3.0567894928417, 3.0712083112042, 3.0856271295666, 3.1000459479291, 3.1144647662915, 3.128883584654, 3.1433024030165, 3.1577212213789, 3.1721400397414, 3.1865588581038, 3.2009776764663, 3.2153964948288, 3.2298153131912, 3.2442341315537, 3.2586529499161, 3.2730717682786, 3.2874905866411, 3.3019094050035, 3.316328223366, 3.3307470417284, 3.3451658600909, 3.3595846784534, 3.3740034968158, 3.3884223151783, 3.4028411335408, 3.4172599519032, 3.4316787702657, 3.4460975886281, 3.4605164069906, 3.4749352253531, 3.4893540437155, 3.503772862078, 3.5181916804404, 3.5326104988029, 3.5470293171654, 3.5614481355278, 3.5758669538903, 3.5902857722527, 3.6047045906152, 3.6191234089777, 3.6335422273401, 3.6479610457026, 3.662379864065, 3.6767986824275},
                       {0, 0.028084023356349, 0.056168046712698, 0.084252070069048, 0.1123360934254, 0.14042011678175, 0.1685041401381, 0.19658816349444, 0.22467218685079, 0.25275621020714, 0.28084023356349, 0.30892425691984, 0.33700828027619, 0.36509230363254, 0.39317632698889, 0.42126035034524, 0.44934437370159, 0.47742839705794, 0.50551242041429, 0.53359644377063, 0.56168046712698, 0.58976449048333, 0.61784851383968, 0.64593253719603, 0.67401656055238, 0.70210058390873, 0.73018460726508, 0.75826863062143, 0.78635265397778, 0.81443667733413, 0.84252070069048, 0.87060472404682, 0.89868874740317, 0.92677277075952, 0.95485679411587, 0.98294081747222, 1.0110248408286, 1.0391088641849, 1.0671928875413, 1.0952769108976, 1.123360934254, 1.1514449576103, 1.1795289809667, 1.207613004323, 1.2356970276794, 1.2637810510357, 1.2918650743921, 1.3199490977484, 1.3480331211048, 1.3761171444611, 1.4042011678175, 1.4322851911738, 1.4603692145302, 1.4884532378865, 1.5165372612429, 1.5446212845992, 1.5727053079556, 1.6007893313119, 1.6288733546683, 1.6569573780246, 1.685041401381, 1.7131254247373, 1.7412094480936, 1.76929347145, 1.7973774948063, 1.8254615181627, 1.853545541519, 1.8816295648754, 1.9097135882317, 1.9377976115881, 1.9658816349444, 1.9939656583008, 2.0220496816571, 2.0501337050135, 2.0782177283698, 2.1063017517262, 2.1343857750825, 2.1624697984389, 2.1905538217952, 2.2186378451516, 2.2467218685079, 2.2748058918643, 2.3028899152206, 2.330973938577, 2.3590579619333, 2.3871419852897, 2.415226008646, 2.4433100320024, 2.4713940553587, 2.4994780787151, 2.5275621020714, 2.5556461254278, 2.5837301487841, 2.6118141721405, 2.6398981954968, 2.6679822188532, 2.6960662422095, 2.7241502655659, 2.7522342889222, 2.7803183122786, 2.8084023356349, 2.8364863589913, 2.8645703823476, 2.892654405704, 2.9207384290603, 2.9488224524167, 2.976906475773, 3.0049904991294, 3.0330745224857, 3.0611585458421, 3.0892425691984, 3.1173265925548, 3.1454106159111, 3.1734946392675, 3.2015786626238, 3.2296626859802, 3.2577467093365, 3.2858307326929, 3.3139147560492, 3.3419987794056, 3.3700828027619, 3.3981668261183, 3.4262508494746, 3.4543348728309, 3.4824188961873, 3.5105029195436, 3.5385869429, 3.5666709662563, 3.5947549896127, 3.622839012969, 3.6509230363254, 3.6790070596817, 3.7070910830381, 3.7351751063944, 3.7632591297508, 3.7913431531071, 3.8194271764635, 3.8475111998198, 3.8755952231762, 3.9036792465325, 3.9317632698889, 3.9598472932452, 3.9879313166016, 4.0160153399579, 4.0440993633143, 4.0721833866706, 4.100267410027, 4.1283514333833, 4.1564354567397, 4.184519480096, 4.2126035034524, 4.2406875268087, 4.2687715501651, 4.2968555735214, 4.3249395968778, 4.3530236202341, 4.3811076435905, 4.4091916669468, 4.4372756903032, 4.4653597136595, 4.4934437370159, 4.5215277603722, 4.5496117837286, 4.5776958070849, 4.6057798304413, 4.6338638537976, 4.661947877154, 4.6900319005103, 4.7181159238667, 4.746199947223, 4.7742839705794, 4.8023679939357, 4.8304520172921, 4.8585360406484, 4.8866200640048, 4.9147040873611, 4.9427881107175, 4.9708721340738, 4.9989561574302, 5.0270401807865, 5.0551242041429, 5.0832082274992, 5.1112922508556, 5.1393762742119, 5.1674602975682, 5.1955443209246, 5.2236283442809, 5.2517123676373, 5.2797963909936, 5.30788041435, 5.3359644377063, 5.3640484610627, 5.392132484419, 5.4202165077754, 5.4483005311317, 5.4763845544881, 5.5044685778444, 5.5325526012008, 5.5606366245571, 5.5887206479135, 5.6168046712698, 5.6448886946262, 5.6729727179825, 5.7010567413389, 5.7291407646952, 5.7572247880516, 5.7853088114079, 5.8133928347643, 5.8414768581206, 5.869560881477, 5.8976449048333, 5.9257289281897, 5.953812951546, 5.9818969749024, 6.0099809982587, 6.0380650216151, 6.0661490449714, 6.0942330683278, 6.1223170916841, 6.1504011150405, 6.1784851383968, 6.2065691617532, 6.2346531851095, 6.2627372084659, 6.2908212318222, 6.3189052551786, 6.3469892785349, 6.3750733018913, 6.4031573252476, 6.431241348604, 6.4593253719603, 6.4874093953167, 6.515493418673, 6.5435774420294, 6.5716614653857, 6.5997454887421, 6.6278295120984, 6.6559135354548, 6.6839975588111, 6.7120815821675, 6.7401656055238, 6.7682496288802, 6.7963336522365, 6.8244176755928, 6.8525016989492, 6.8805857223055, 6.9086697456619, 6.9367537690182, 6.9648377923746, 6.9929218157309, 7.0210058390873, 7.0490898624436, 7.0771738858, 7.1052579091563, 7.1333419325127, 7.161425955869},
                       {0, 0.035072700805593, 0.070145401611187, 0.10521810241678, 0.14029080322237, 0.17536350402797, 0.21043620483356, 0.24550890563915, 0.28058160644475, 0.31565430725034, 0.35072700805593, 0.38579970886153, 0.42087240966712, 0.45594511047272, 0.49101781127831, 0.5260905120839, 0.5611632128895, 0.59623591369509, 0.63130861450068, 0.66638131530628, 0.70145401611187, 0.73652671691746, 0.77159941772306, 0.80667211852865, 0.84174481933424, 0.87681752013984, 0.91189022094543, 0.94696292175102, 0.98203562255662, 1.0171083233622, 1.0521810241678, 1.0872537249734, 1.122326425779, 1.1573991265846, 1.1924718273902, 1.2275445281958, 1.2626172290014, 1.297689929807, 1.3327626306126, 1.3678353314181, 1.4029080322237, 1.4379807330293, 1.4730534338349, 1.5081261346405, 1.5431988354461, 1.5782715362517, 1.6133442370573, 1.6484169378629, 1.6834896386685, 1.7185623394741, 1.7536350402797, 1.7887077410853, 1.8237804418909, 1.8588531426965, 1.893925843502, 1.9289985443076, 1.9640712451132, 1.9991439459188, 2.0342166467244, 2.06928934753, 2.1043620483356, 2.1394347491412, 2.1745074499468, 2.2095801507524, 2.244652851558, 2.2797255523636, 2.3147982531692, 2.3498709539748, 2.3849436547804, 2.420016355586, 2.4550890563915, 2.4901617571971, 2.5252344580027, 2.5603071588083, 2.5953798596139, 2.6304525604195, 2.6655252612251, 2.7005979620307, 2.7356706628363, 2.7707433636419, 2.8058160644475, 2.8408887652531, 2.8759614660587, 2.9110341668643, 2.9461068676699, 2.9811795684754, 3.016252269281, 3.0513249700866, 3.0863976708922, 3.1214703716978, 3.1565430725034, 3.191615773309, 3.2266884741146, 3.2617611749202, 3.2968338757258, 3.3319065765314, 3.366979277337, 3.4020519781426, 3.4371246789482, 3.4721973797538, 3.5072700805593, 3.5423427813649, 3.5774154821705, 3.6124881829761, 3.6475608837817, 3.6826335845873, 3.7177062853929, 3.7527789861985, 3.7878516870041, 3.8229243878097, 3.8579970886153, 3.8930697894209, 3.9281424902265, 3.9632151910321, 3.9982878918377, 4.0333605926433, 4.0684332934488, 4.1035059942544, 4.13857869506, 4.1736513958656, 4.2087240966712, 4.2437967974768, 4.2788694982824, 4.313942199088, 4.3490148998936, 4.3840876006992, 4.4191603015048, 4.4542330023104, 4.489305703116, 4.5243784039216, 4.5594511047272, 4.5945238055327, 4.6295965063383, 4.6646692071439, 4.6997419079495, 4.7348146087551, 4.7698873095607, 4.8049600103663, 4.8400327111719, 4.8751054119775, 4.9101781127831, 4.9452508135887, 4.9803235143943, 5.0153962151999, 5.0504689160055, 5.0855416168111, 5.1206143176167, 5.1556870184222, 5.1907597192278, 5.2258324200334, 5.260905120839, 5.2959778216446, 5.3310505224502, 5.3661232232558, 5.4011959240614, 5.436268624867, 5.4713413256726, 5.5064140264782, 5.5414867272838, 5.5765594280894, 5.611632128895, 5.6467048297006, 5.6817775305061, 5.7168502313117, 5.7519229321173, 5.7869956329229, 5.8220683337285, 5.8571410345341, 5.8922137353397, 5.9272864361453, 5.9623591369509, 5.9974318377565, 6.0325045385621, 6.0675772393677, 6.1026499401733, 6.1377226409789, 6.1727953417845, 6.20786804259, 6.2429407433956, 6.2780134442012, 6.3130861450068, 6.3481588458124, 6.383231546618, 6.4183042474236, 6.4533769482292, 6.4884496490348, 6.5235223498404, 6.558595050646, 6.5936677514516, 6.6287404522572, 6.6638131530628, 6.6988858538684, 6.733958554674, 6.7690312554795, 6.8041039562851, 6.8391766570907, 6.8742493578963, 6.9093220587019, 6.9443947595075, 6.9794674603131, 7.0145401611187, 7.0496128619243, 7.0846855627299, 7.1197582635355, 7.1548309643411, 7.1899036651467, 7.2249763659523, 7.2600490667579, 7.2951217675634, 7.330194468369, 7.3652671691746, 7.4003398699802, 7.4354125707858, 7.4704852715914, 7.505557972397, 7.5406306732026, 7.5757033740082, 7.6107760748138, 7.6458487756194, 7.680921476425, 7.7159941772306, 7.7510668780362, 7.7861395788418, 7.8212122796474, 7.8562849804529, 7.8913576812585, 7.9264303820641, 7.9615030828697, 7.9965757836753, 8.0316484844809, 8.0667211852865, 8.1017938860921, 8.1368665868977, 8.1719392877033, 8.2070119885089, 8.2420846893145, 8.2771573901201, 8.3122300909257, 8.3473027917313, 8.3823754925368, 8.4174481933424, 8.452520894148, 8.4875935949536, 8.5226662957592, 8.5577389965648, 8.5928116973704, 8.627884398176, 8.6629570989816, 8.6980297997872, 8.7331025005928, 8.7681752013984, 8.803247902204, 8.8383206030096, 8.8733933038152, 8.9084660046207, 8.9435387054263},
                       {0, 0.054700208300936, 0.10940041660187, 0.16410062490281, 0.21880083320374, 0.27350104150468, 0.32820124980562, 0.38290145810655, 0.43760166640749, 0.49230187470842, 0.54700208300936, 0.60170229131029, 0.65640249961123, 0.71110270791217, 0.7658029162131, 0.82050312451404, 0.87520333281497, 0.92990354111591, 0.98460374941685, 1.0393039577178, 1.0940041660187, 1.1487043743197, 1.2034045826206, 1.2581047909215, 1.3128049992225, 1.3675052075234, 1.4222054158243, 1.4769056241253, 1.5316058324262, 1.5863060407271, 1.6410062490281, 1.695706457329, 1.7504066656299, 1.8051068739309, 1.8598070822318, 1.9145072905328, 1.9692074988337, 2.0239077071346, 2.0786079154356, 2.1333081237365, 2.1880083320374, 2.2427085403384, 2.2974087486393, 2.3521089569402, 2.4068091652412, 2.4615093735421, 2.5162095818431, 2.570909790144, 2.6256099984449, 2.6803102067459, 2.7350104150468, 2.7897106233477, 2.8444108316487, 2.8991110399496, 2.9538112482505, 3.0085114565515, 3.0632116648524, 3.1179118731533, 3.1726120814543, 3.2273122897552, 3.2820124980562, 3.3367127063571, 3.391412914658, 3.446113122959, 3.5008133312599, 3.5555135395608, 3.6102137478618, 3.6649139561627, 3.7196141644636, 3.7743143727646, 3.8290145810655, 3.8837147893664, 3.9384149976674, 3.9931152059683, 4.0478154142693, 4.1025156225702, 4.1572158308711, 4.2119160391721, 4.266616247473, 4.3213164557739, 4.3760166640749, 4.4307168723758, 4.4854170806767, 4.5401172889777, 4.5948174972786, 4.6495177055796, 4.7042179138805, 4.7589181221814, 4.8136183304824, 4.8683185387833, 4.9230187470842, 4.9777189553852, 5.0324191636861, 5.087119371987, 5.141819580288, 5.1965197885889, 5.2512199968898, 5.3059202051908, 5.3606204134917, 5.4153206217927, 5.4700208300936, 5.5247210383945, 5.5794212466955, 5.6341214549964, 5.6888216632973, 5.7435218715983, 5.7982220798992, 5.8529222882001, 5.9076224965011, 5.962322704802, 6.0170229131029, 6.0717231214039, 6.1264233297048, 6.1811235380058, 6.2358237463067, 6.2905239546076, 6.3452241629086, 6.3999243712095, 6.4546245795104, 6.5093247878114, 6.5640249961123, 6.6187252044132, 6.6734254127142, 6.7281256210151, 6.7828258293161, 6.837526037617, 6.8922262459179, 6.9469264542189, 7.0016266625198, 7.0563268708207, 7.1110270791217, 7.1657272874226, 7.2204274957235, 7.2751277040245, 7.3298279123254, 7.3845281206263, 7.4392283289273, 7.4939285372282, 7.5486287455292, 7.6033289538301, 7.658029162131, 7.712729370432, 7.7674295787329, 7.8221297870338, 7.8768299953348, 7.9315302036357, 7.9862304119366, 8.0409306202376, 8.0956308285385, 8.1503310368394, 8.2050312451404, 8.2597314534413, 8.3144316617423, 8.3691318700432, 8.4238320783441, 8.4785322866451, 8.533232494946, 8.5879327032469, 8.6426329115479, 8.6973331198488, 8.7520333281497, 8.8067335364507, 8.8614337447516, 8.9161339530525, 8.9708341613535, 9.0255343696544, 9.0802345779554, 9.1349347862563, 9.1896349945572, 9.2443352028582, 9.2990354111591, 9.35373561946, 9.408435827761, 9.4631360360619, 9.5178362443628, 9.5725364526638, 9.6272366609647, 9.6819368692657, 9.7366370775666, 9.7913372858675, 9.8460374941685, 9.9007377024694, 9.9554379107703, 10.010138119071, 10.064838327372, 10.119538535673, 10.174238743974, 10.228938952275, 10.283639160576, 10.338339368877, 10.393039577178, 10.447739785479, 10.50243999378, 10.557140202081, 10.611840410382, 10.666540618682, 10.721240826983, 10.775941035284, 10.830641243585, 10.885341451886, 10.940041660187, 10.994741868488, 11.049442076789, 11.10414228509, 11.158842493391, 11.213542701692, 11.268242909993, 11.322943118294, 11.377643326595, 11.432343534896, 11.487043743197, 11.541743951497, 11.596444159798, 11.651144368099, 11.7058445764, 11.760544784701, 11.815244993002, 11.869945201303, 11.924645409604, 11.979345617905, 12.034045826206, 12.088746034507, 12.143446242808, 12.198146451109, 12.25284665941, 12.307546867711, 12.362247076012, 12.416947284312, 12.471647492613, 12.526347700914, 12.581047909215, 12.635748117516, 12.690448325817, 12.745148534118, 12.799848742419, 12.85454895072, 12.909249159021, 12.963949367322, 13.018649575623, 13.073349783924, 13.128049992225, 13.182750200526, 13.237450408826, 13.292150617127, 13.346850825428, 13.401551033729, 13.45625124203, 13.510951450331, 13.565651658632, 13.620351866933, 13.675052075234, 13.729752283535, 13.784452491836, 13.839152700137, 13.893852908438, 13.948553116739},
                       {0, 0.06831229327078, 0.13662458654156, 0.20493687981234, 0.27324917308312, 0.3415614663539, 0.40987375962468, 0.47818605289546, 0.54649834616624, 0.61481063943702, 0.6831229327078, 0.75143522597858, 0.81974751924936, 0.88805981252014, 0.95637210579092, 1.0246843990617, 1.0929966923325, 1.1613089856033, 1.229621278874, 1.2979335721448, 1.3662458654156, 1.4345581586864, 1.5028704519572, 1.5711827452279, 1.6394950384987, 1.7078073317695, 1.7761196250403, 1.8444319183111, 1.9127442115818, 1.9810565048526, 2.0493687981234, 2.1176810913942, 2.185993384665, 2.2543056779357, 2.3226179712065, 2.3909302644773, 2.4592425577481, 2.5275548510189, 2.5958671442896, 2.6641794375604, 2.7324917308312, 2.800804024102, 2.8691163173728, 2.9374286106435, 3.0057409039143, 3.0740531971851, 3.1423654904559, 3.2106777837267, 3.2789900769975, 3.3473023702682, 3.415614663539, 3.4839269568098, 3.5522392500806, 3.6205515433514, 3.6888638366221, 3.7571761298929, 3.8254884231637, 3.8938007164345, 3.9621130097053, 4.030425302976, 4.0987375962468, 4.1670498895176, 4.2353621827884, 4.3036744760592, 4.3719867693299, 4.4402990626007, 4.5086113558715, 4.5769236491423, 4.6452359424131, 4.7135482356838, 4.7818605289546, 4.8501728222254, 4.9184851154962, 4.986797408767, 5.0551097020377, 5.1234219953085, 5.1917342885793, 5.2600465818501, 5.3283588751209, 5.3966711683916, 5.4649834616624, 5.5332957549332, 5.601608048204, 5.6699203414748, 5.7382326347455, 5.8065449280163, 5.8748572212871, 5.9431695145579, 6.0114818078287, 6.0797941010994, 6.1481063943702, 6.216418687641, 6.2847309809118, 6.3530432741826, 6.4213555674533, 6.4896678607241, 6.5579801539949, 6.6262924472657, 6.6946047405365, 6.7629170338072, 6.831229327078, 6.8995416203488, 6.9678539136196, 7.0361662068904, 7.1044785001611, 7.1727907934319, 7.2411030867027, 7.3094153799735, 7.3777276732443, 7.446039966515, 7.5143522597858, 7.5826645530566, 7.6509768463274, 7.7192891395982, 7.7876014328689, 7.8559137261397, 7.9242260194105, 7.9925383126813, 8.0608506059521, 8.1291628992228, 8.1974751924936, 8.2657874857644, 8.3340997790352, 8.402412072306, 8.4707243655767, 8.5390366588475, 8.6073489521183, 8.6756612453891, 8.7439735386599, 8.8122858319306, 8.8805981252014, 8.9489104184722, 9.017222711743, 9.0855350050138, 9.1538472982845, 9.2221595915553, 9.2904718848261, 9.3587841780969, 9.4270964713677, 9.4954087646384, 9.5637210579092, 9.63203335118, 9.7003456444508, 9.7686579377216, 9.8369702309924, 9.9052825242631, 9.9735948175339, 10.041907110805, 10.110219404075, 10.178531697346, 10.246843990617, 10.315156283888, 10.383468577159, 10.451780870429, 10.5200931637, 10.588405456971, 10.656717750242, 10.725030043512, 10.793342336783, 10.861654630054, 10.929966923325, 10.998279216596, 11.066591509866, 11.134903803137, 11.203216096408, 11.271528389679, 11.33984068295, 11.40815297622, 11.476465269491, 11.544777562762, 11.613089856033, 11.681402149303, 11.749714442574, 11.818026735845, 11.886339029116, 11.954651322387, 12.022963615657, 12.091275908928, 12.159588202199, 12.22790049547, 12.29621278874, 12.364525082011, 12.432837375282, 12.501149668553, 12.569461961824, 12.637774255094, 12.706086548365, 12.774398841636, 12.842711134907, 12.911023428177, 12.979335721448, 13.047648014719, 13.11596030799, 13.184272601261, 13.252584894531, 13.320897187802, 13.389209481073, 13.457521774344, 13.525834067614, 13.594146360885, 13.662458654156, 13.730770947427, 13.799083240698, 13.867395533968, 13.935707827239, 14.00402012051, 14.072332413781, 14.140644707052, 14.208957000322, 14.277269293593, 14.345581586864, 14.413893880135, 14.482206173405, 14.550518466676, 14.618830759947, 14.687143053218, 14.755455346489, 14.823767639759, 14.89207993303, 14.960392226301, 15.028704519572, 15.097016812842, 15.165329106113, 15.233641399384, 15.301953692655, 15.370265985926, 15.438578279196, 15.506890572467, 15.575202865738, 15.643515159009, 15.711827452279, 15.78013974555, 15.848452038821, 15.916764332092, 15.985076625363, 16.053388918633, 16.121701211904, 16.190013505175, 16.258325798446, 16.326638091716, 16.394950384987, 16.463262678258, 16.531574971529, 16.5998872648, 16.66819955807, 16.736511851341, 16.804824144612, 16.873136437883, 16.941448731153, 17.009761024424, 17.078073317695, 17.146385610966, 17.214697904237, 17.283010197507, 17.351322490778, 17.419634784049},
                       {0, 0.085311730190125, 0.17062346038025, 0.25593519057038, 0.3412469207605, 0.42655865095063, 0.51187038114075, 0.59718211133088, 0.682493841521, 0.76780557171113, 0.85311730190125, 0.93842903209138, 1.0237407622815, 1.1090524924716, 1.1943642226618, 1.2796759528519, 1.364987683042, 1.4502994132321, 1.5356111434223, 1.6209228736124, 1.7062346038025, 1.7915463339926, 1.8768580641828, 1.9621697943729, 2.047481524563, 2.1327932547531, 2.2181049849433, 2.3034167151334, 2.3887284453235, 2.4740401755136, 2.5593519057038, 2.6446636358939, 2.729975366084, 2.8152870962741, 2.9005988264643, 2.9859105566544, 3.0712222868445, 3.1565340170346, 3.2418457472248, 3.3271574774149, 3.412469207605, 3.4977809377951, 3.5830926679853, 3.6684043981754, 3.7537161283655, 3.8390278585556, 3.9243395887458, 4.0096513189359, 4.094963049126, 4.1802747793161, 4.2655865095063, 4.3508982396964, 4.4362099698865, 4.5215217000766, 4.6068334302668, 4.6921451604569, 4.777456890647, 4.8627686208371, 4.9480803510273, 5.0333920812174, 5.1187038114075, 5.2040155415976, 5.2893272717878, 5.3746390019779, 5.459950732168, 5.5452624623581, 5.6305741925483, 5.7158859227384, 5.8011976529285, 5.8865093831186, 5.9718211133088, 6.0571328434989, 6.142444573689, 6.2277563038791, 6.3130680340693, 6.3983797642594, 6.4836914944495, 6.5690032246396, 6.6543149548298, 6.7396266850199, 6.82493841521, 6.9102501454001, 6.9955618755903, 7.0808736057804, 7.1661853359705, 7.2514970661606, 7.3368087963508, 7.4221205265409, 7.507432256731, 7.5927439869211, 7.6780557171113, 7.7633674473014, 7.8486791774915, 7.9339909076816, 8.0193026378718, 8.1046143680619, 8.189926098252, 8.2752378284421, 8.3605495586323, 8.4458612888224, 8.5311730190125, 8.6164847492026, 8.7017964793928, 8.7871082095829, 8.872419939773, 8.9577316699631, 9.0430434001533, 9.1283551303434, 9.2136668605335, 9.2989785907236, 9.3842903209138, 9.4696020511039, 9.554913781294, 9.6402255114841, 9.7255372416743, 9.8108489718644, 9.8961607020545, 9.9814724322446, 10.066784162435, 10.152095892625, 10.237407622815, 10.322719353005, 10.408031083195, 10.493342813385, 10.578654543576, 10.663966273766, 10.749278003956, 10.834589734146, 10.919901464336, 11.005213194526, 11.090524924716, 11.175836654906, 11.261148385097, 11.346460115287, 11.431771845477, 11.517083575667, 11.602395305857, 11.687707036047, 11.773018766237, 11.858330496427, 11.943642226618, 12.028953956808, 12.114265686998, 12.199577417188, 12.284889147378, 12.370200877568, 12.455512607758, 12.540824337948, 12.626136068139, 12.711447798329, 12.796759528519, 12.882071258709, 12.967382988899, 13.052694719089, 13.138006449279, 13.223318179469, 13.30862990966, 13.39394163985, 13.47925337004, 13.56456510023, 13.64987683042, 13.73518856061, 13.8205002908, 13.90581202099, 13.991123751181, 14.076435481371, 14.161747211561, 14.247058941751, 14.332370671941, 14.417682402131, 14.502994132321, 14.588305862511, 14.673617592702, 14.758929322892, 14.844241053082, 14.929552783272, 15.014864513462, 15.100176243652, 15.185487973842, 15.270799704032, 15.356111434223, 15.441423164413, 15.526734894603, 15.612046624793, 15.697358354983, 15.782670085173, 15.867981815363, 15.953293545553, 16.038605275744, 16.123917005934, 16.209228736124, 16.294540466314, 16.379852196504, 16.465163926694, 16.550475656884, 16.635787387074, 16.721099117265, 16.806410847455, 16.891722577645, 16.977034307835, 17.062346038025, 17.147657768215, 17.232969498405, 17.318281228595, 17.403592958786, 17.488904688976, 17.574216419166, 17.659528149356, 17.744839879546, 17.830151609736, 17.915463339926, 18.000775070116, 18.086086800307, 18.171398530497, 18.256710260687, 18.342021990877, 18.427333721067, 18.512645451257, 18.597957181447, 18.683268911637, 18.768580641828, 18.853892372018, 18.939204102208, 19.024515832398, 19.109827562588, 19.195139292778, 19.280451022968, 19.365762753158, 19.451074483349, 19.536386213539, 19.621697943729, 19.707009673919, 19.792321404109, 19.877633134299, 19.962944864489, 20.048256594679, 20.13356832487, 20.21888005506, 20.30419178525, 20.38950351544, 20.47481524563, 20.56012697582, 20.64543870601, 20.7307504362, 20.816062166391, 20.901373896581, 20.986685626771, 21.071997356961, 21.157309087151, 21.242620817341, 21.327932547531, 21.413244277721, 21.498556007912, 21.583867738102, 21.669179468292, 21.754491198482}};
double GsCore[5][5]={
    {0.01441881,0.02808402,0.03507270,0.02808402,0.01441881 },
    {0.02808402,0.0547002, 0.06831229,0.0547002 ,0.02808402}, 
    {0.0350727 ,0.06831229,0.08531173,0.06831229,0.03507270},
    {0.02808402,0.0547002 ,0.06831229,0.0547002 ,0.02808402}, 
    {0.01441881,0.02808402,0.03507270,0.02808402,0.01441881} 
};


/********************************************************************************/

void showBmpHead(BITMAPFILEHEADER &pBmpHead)
{
    cout << "==========位图文件头==========" << endl;
    cout << "文件头类型:" << pBmpHead.bfType << endl;
    cout << "文件大小:" << pBmpHead.bfSize << endl;
    cout << "保留字_1:" << pBmpHead.bfReserved1 << endl;
    cout << "保留字_2:" << pBmpHead.bfReserved2 << endl;
    cout << "实际位图数据的偏移字节数:" << pBmpHead.bfOffBits << endl
         << endl;
}

void showBmpInforHead(BITMAPINFODEADER &pBmpInforHead)
{
    cout << "==========位图信息头==========" << endl;
    cout << "结构体的长度:" << pBmpInforHead.biSize << endl;
    cout << "位图宽:" << pBmpInforHead.biWidth << endl;
    cout << "位图高:" << pBmpInforHead.biHeight << endl;
    cout << "biPlanes平面数:" << pBmpInforHead.biPlanes << endl;
    cout << "biBitCount采用颜色位数:" << pBmpInforHead.biBitCount << endl;
    cout << "压缩方式:" << pBmpInforHead.biCompression << endl;
    cout << "biSizeImage实际位图数据占用的字节数:" << pBmpInforHead.biSizeImage << endl;
    cout << "X方向分辨率:" << pBmpInforHead.biXPelsPerMeter << endl;
    cout << "Y方向分辨率:" << pBmpInforHead.biYPelsPerMeter << endl;
    cout << "使用的颜色数:" << pBmpInforHead.biClrUsed << endl;
    cout << "重要颜色数:" << pBmpInforHead.biClrImportant << endl;
}

void readBmp(FILE *fp, unsigned char *&pBmpBuf, int BmpWidth, int BmpHeight,
             int BiBitCount,int startx,int endx) 
{
    /**
     * 灰度图像有颜色表，且颜色表表项为256
     * (可以理解为lineByte是对bmpWidth的以4为步长的向上取整)
     */
    int lineByte = (BmpWidth * BiBitCount / 8 + 3) / 4 * 4;

    //申请位图数据所需要的空间，读位图数据进内存
    pBmpBuf = new (nothrow) unsigned char[lineByte * BmpHeight];

    if (pBmpBuf == NULL)
    {
        cerr << "Mem alloc failed." << endl;
        exit(-1);
    }
    if(startx-2>0)
        startx=startx-2;
    if(endx+2<BmpHeight)
        endx=endx+2;

    fseek(fp,startx*lineByte,SEEK_CUR);
    fread(pBmpBuf+startx*lineByte, lineByte * (endx-startx+1), 1, fp);

    return;
}

//给定一个图像位图数据、宽、高、颜色表指针及每像素所占的位数等信息,将其写到指定文件中
bool saveBmp(const char *bmpName, unsigned char *imgBuf, int width, int height,
             int biBitCount)
{
    //如果位图数据指针为0，则没有数据传入，函数返回
    if (!imgBuf)
        return 0;

    //颜色表大小，以字节为单位，灰度图像颜色表为1024字节，彩色图像颜色表大小为0
    int colorTablesize = 0;

    if (biBitCount == 8)
        colorTablesize = 1024; // 8*128

    //待存储图像数据每行字节数为4的倍数
    int lineByte = (width * biBitCount / 8 + 3) / 4 * 4;

    //以二进制写的方式打开文件
    FILE *fp = fopen(bmpName, "wb");

    if (fp == 0)
    {
        cerr << "Open file error." << endl;
        return 0;
    }

    //申请位图文件头结构变量，填写文件头信息
    BITMAPFILEHEADER fileHead;

    fileHead.bfType = 0x4D42; // bmp类型

    // bfSize是图像文件4个组成部分之和
    fileHead.bfSize = sizeof(BITMAPFILEHEADER) + sizeof(BITMAPINFOHEADER) +
                      colorTablesize + lineByte * height;
    fileHead.bfReserved1 = 0;
    fileHead.bfReserved2 = 0;

    // bfOffBits是图像文件前3个部分所需空间之和
    fileHead.bfOffBits = 54 + colorTablesize;

    //写文件头进文件
    fwrite(&fileHead, sizeof(BITMAPFILEHEADER), 1, fp);

    //申请位图信息头结构变量，填写信息头信息
    BITMAPINFOHEADER head;

    head.biBitCount = biBitCount;
    head.biClrImportant = 0;
    head.biClrUsed = 0;
    head.biCompression = 0;
    head.biHeight = height;
    head.biPlanes = 1;
    head.biSize = 40;
    head.biSizeImage = lineByte * height;
    head.biWidth = width;
    head.biXPelsPerMeter = 0;
    head.biYPelsPerMeter = 0;

    //写位图信息头进内存
    fwrite(&head, sizeof(BITMAPINFOHEADER), 1, fp);

    //写位图数据进文件
    fwrite(imgBuf, height * lineByte, 1, fp);

    //关闭文件
    fclose(fp);

    return 1;
}
//将多通道颜色数据拆分成三个数组
void reFormChannel(int numWidth, int numHeigh,int sx,int sy)
{
    //新数组的高度和宽度
    int reFormHeigh = numHeigh + N / 2 + N / 2;
    int reFormWidth = numWidth + N / 2 + N / 2;

    //申请动态数组
    int i, j;
    rBmpBuf = new (nothrow) unsigned char[reFormHeigh * reFormWidth];
    gBmpBuf = new (nothrow) unsigned char[reFormHeigh * reFormWidth];
    bBmpBuf = new (nothrow) unsigned char[reFormHeigh * reFormWidth];

    //赋值并补0
    int pos;
    int pos_i;

    int starti=sx;
    int stopi=sy+N-1;
    numWidth*=3;
    numHeigh+=2;
    for (i = starti; i <= stopi; i++)
    {
        for (j = 0; j < reFormWidth; j++)
        {
            pos = i * reFormWidth + j;
            pos_i = (i - 2) * numWidth + (j - 2) * 3;
            if (i < 2 || i >= numHeigh)
            {
                rBmpBuf[pos] = 0;
                gBmpBuf[pos] = 0;
                bBmpBuf[pos] = 0;
            }
            else if (j < 2 || j >= numWidth)
            {
                rBmpBuf[pos] = 0;
                gBmpBuf[pos] = 0;
                bBmpBuf[pos] = 0;
            }
            else
            {
                rBmpBuf[pos] = pBmpBuf[pos_i];
                gBmpBuf[pos] = pBmpBuf[pos_i + 1];
                bBmpBuf[pos] = pBmpBuf[pos_i + 2];
            }
        }
    }
}


int Value;
int len = N / 2;
int vvv = -len * Value;

unsigned char getValue(int ii, unsigned char *arrary)
{
    int vv = vvv;
    ii = ii - vvv; 

    double sum1=0;
    double sum2=0;
    double sum3=0;
    double sum4=0;
    double sum5=0;

    vv = vvv;
    vv += ii;
    sum1 += book[0][arrary[vv - 2]];
    sum2 += book[0][arrary[vv + 2]];
    sum3 += book[1][arrary[vv - 1]];
    sum4 += book[1][arrary[vv + 1]];
    sum5 += book[2][arrary[vv]];

    vv += Value;
    sum1 += book[1][arrary[vv - 2]];
    sum2 += book[1][arrary[vv + 2]];
    sum3 += book[3][arrary[vv - 1]];
    sum4 += book[3][arrary[vv + 1]];
    sum5 += book[4][arrary[vv]];

    vv += Value;
    sum1 += book[4][arrary[vv + 1]];
    sum2 += book[4][arrary[vv - 1]];
    sum3 += book[5][arrary[vv]];
    sum4 += book[2][arrary[vv + 2]];
    sum5 += book[2][arrary[vv - 2]];

    vv += Value;
    sum1 += book[3][arrary[vv + 1]];
    sum2 += book[3][arrary[vv - 1]];
    sum3 += book[4][arrary[vv]];
    sum4 += book[1][arrary[vv - 2]];
    sum5 += book[1][arrary[vv + 2]];

    vv += Value;
    sum1 += book[1][arrary[vv - 1]];
    sum2 += book[1][arrary[vv + 1]];
    sum3 += book[0][arrary[vv - 2]];
    sum4 += book[0][arrary[vv + 2]];
    sum5 += book[2][arrary[vv]];


    return sum1+sum2+sum3+sum4+sum5;
}

/**
 * 卷积公共计算部分
 */

unsigned char *convolution(unsigned char *resBuf, int start_x, int end_x, int BmpWidth)
{

    int ii;
    int reFormWidth = BmpWidth * 3;
    int endi = (end_x + 1) * reFormWidth;

    int xx_v = start_x * (BmpWidth + N / 2 + N / 2) + N / 2;
    int xx=xx_v;
    int yy = 0;
    int xx_add = (BmpWidth + N / 2 + N / 2);
    int yy_v = BmpWidth;
    for (ii = start_x * reFormWidth; ii < endi; ii = ii + 3)
    {
        if (yy == yy_v)
        {
            xx = xx + xx_add;
            yy = 0;
        }
        resBuf[ii] = getValue(xx + yy, rBmpBuf);
        yy++;
    }
    yy=0;
    xx=xx_v;
    endi=endi+1;
    for (ii = start_x * reFormWidth+1; ii < endi; ii = ii + 3)
    {
        if (yy == yy_v)
        {
            xx = xx + xx_add;
            yy = 0;
        }
        resBuf[ii] = getValue(xx + yy, gBmpBuf);
        yy++;
    }
    yy=0;
    xx=xx_v;
    endi=endi+1;
    for (ii = start_x * reFormWidth+2; ii < endi; ii = ii + 3)
    {
        if (yy == yy_v)
        {
            xx = xx + xx_add;
            yy = 0;
        }
        resBuf[ii] = getValue(xx + yy, bBmpBuf);
        yy++;
    }

    return 0;
}


void preAction()
{
    for (int i = 0; i <= 255; i++)
    {
        book[0][i] = i * GsCore[0][0];
        book[1][i] = i * GsCore[0][1];
        book[2][i] = i * GsCore[0][2];
        book[3][i] = i * GsCore[1][1];
        book[4][i] = i * GsCore[1][2];
        book[5][i] = i * GsCore[2][2];
    }
}

int main(int argc, char *argv[])
{

    int size, myrank, source, dest;
    MPI_Init(&argc, &argv);
    MPI_Comm_rank(MPI_COMM_WORLD, &myrank);
    MPI_Comm_size(MPI_COMM_WORLD, &size);
    MPI_Status status;

    double start_time, end_time;
    start_time = MPI_Wtime();
    preAction();
    unsigned char *resBuf;
    unsigned char *result;

    BITMAPFILEHEADER BmpHead;
    BITMAPINFODEADER BmpInfo;

    int BmpWidth;   //图像的宽
    int BmpHeight;  //图像的高
    int BiBitCount; //图像类型，每像素位数 8-灰度图 24-彩色图

    FILE *fp = fopen(BMP_FILE_NAME, "rb"); //二进制读方式打开指定的图像文件
    if (fp == 0)
    {
        cerr << "Can not open " << BMP_FILE_NAME << endl;
        return 0;
    }
    //获取位图文件头结构BITMAPFILEHEADER
    fread(&BmpHead, sizeof(BITMAPFILEHEADER), 1, fp);

    //获取图像宽、高、每像素所占位数等信息
    fread(&BmpInfo, sizeof(BITMAPINFOHEADER), 1, fp);

    if (myrank != 0)
    { //非0号进程发送消息

        BmpWidth = BmpInfo.biWidth;   //宽度用来计算每行像素的字节数
        BmpHeight = BmpInfo.biHeight; // 像素的行数

        //计算图像每行像素所占的字节数（必须是4的倍数）
        BiBitCount = BmpInfo.biBitCount;
        // 将图片读取到内存中

       
        //////////////////////////////////////////////////////////////////
        //完成图片读取,进行数据预处理
        //////////////////////////////////////////////////////////////////

        // 计算卷积核
       // genGsCore(); //可以替换为固定大小的卷积核
        // 将多通道转换为单通道数据
        //使用im2col 算法进行数据优化

        // MPI 并行计算部分
        //MPI_Status status;

        int pixStep = 3; // 移动一个像素指针移动的字节数

        int start_x, end_x; // 起始的像素点以及计算区域
        int conv_byte_size; // 卷积区域字节数
        Value = BmpWidth + N / 2 + N / 2;

        resBuf = new unsigned char[BmpWidth * 3 * BmpHeight];
        memset(resBuf, 0, BmpWidth * 3 * BmpHeight);

        start_x = myrank * BmpHeight / size;
        end_x = start_x + BmpHeight / size - 1;
        if (myrank == size - 1)
            end_x = BmpHeight - 1;
        dest = 0;

        readBmp(fp, pBmpBuf, BmpWidth, BmpHeight, BiBitCount,start_x,end_x);
        //printf("%d process read time: %1.2f\n", myrank, MPI_Wtime() - start_time);
        reFormChannel(BmpWidth, BmpHeight,start_x,end_x);


        //printf("%d process reform time: %1.2f\n", myrank, MPI_Wtime() - start_time);
        convolution(resBuf, start_x, end_x, BmpWidth);
        //printf("%d process cal time: %1.2f\n", myrank, MPI_Wtime() - start_time);
        int seek=start_x * (BmpWidth)*3;

        MPI_Send(resBuf+seek, (end_x-start_x+1)*BmpWidth*3, MPI_UNSIGNED_CHAR, dest, 99, MPI_COMM_WORLD);
        printf("%d process time used to be: %1.2f\n", myrank, MPI_Wtime() - start_time);
    }
    else
    { // myrank == 0，即0号进程参与计算并负责接受数据

        BmpWidth = BmpInfo.biWidth;   //宽度用来计算每行像素的字节数
        BmpHeight = BmpInfo.biHeight; // 像素的行数
        result = new unsigned char[BmpWidth * BmpHeight * 3];
        //计算图像每行像素所占的字节数（必须是4的倍数）
        BiBitCount = BmpInfo.biBitCount;
        // 将图片读取到内存中
        


        //////////////////////////////////////////////////////////////////
        //完成图片读取,进行数据预处理
        //////////////////////////////////////////////////////////////////

        // 计算卷积核
        //genGsCore(); //可以替换为固定大小的卷积核
        // 将多通道转换为单通道数据
        //使用im2col 算法进行数据优化

        // MPI 并行计算部分

        //MPI_Status status;

        int pixStep = 3; // 移动一个像素指针移动的字节数

        int start_x, end_x; // 起始的像素点以及计算区域
        int conv_byte_size; // 卷积区域字节数
        Value = BmpWidth + N / 2 + N / 2;

        resBuf = new unsigned char[BmpWidth * 3 * BmpHeight];
        memset(resBuf, 0, BmpWidth * 3 * BmpHeight);
        start_x = myrank * BmpHeight / size;
        end_x = start_x + BmpHeight / size - 1;
        if (myrank == size - 1)
            end_x = BmpHeight - 1;


        readBmp(fp, pBmpBuf, BmpWidth, BmpHeight, BiBitCount,start_x,end_x);
        //printf("%d process read time: %1.2f\n", myrank, MPI_Wtime() - start_time);
        reFormChannel(BmpWidth, BmpHeight,start_x,end_x);

        //printf("0 process reform time: %1.2f\n",  MPI_Wtime() - start_time);

        convolution(resBuf, start_x, end_x, BmpWidth);


        memcpy(result, resBuf, BmpHeight / size * BmpWidth * 3);

        // 合并结果
       // printf("0 process cal time used to be: %1.2f\n",  MPI_Wtime() - start_time);
        for (source = 1; source < size; source++)
        {
            MPI_Recv(resBuf, BmpWidth * 3 * BmpHeight, MPI_UNSIGNED_CHAR, MPI_ANY_SOURCE, 99, MPI_COMM_WORLD, &status);
            if (status.MPI_SOURCE != size - 1)
                memcpy(result + status.MPI_SOURCE * BmpHeight / size * BmpWidth * 3, resBuf, status.count);
            else
                memcpy(result + status.MPI_SOURCE * BmpHeight / size * BmpWidth * 3, resBuf, status.count);
        }
        saveBmp("final.bmp", result, BmpWidth, BmpHeight, BiBitCount);
        printf("All time used to be: %1.2f\n",  MPI_Wtime() - start_time);
        delete result;
    }

END:

    delete rBmpBuf;
    delete gBmpBuf;
    delete bBmpBuf;
    delete resBuf;
    MPI_Finalize();
    // MPI End

    if (pBmpBuf)
        delete pBmpBuf;
    fclose(fp);

    return 0;
}